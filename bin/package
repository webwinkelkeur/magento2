#!/bin/bash

set -euo pipefail
cd "$(dirname "$0")/.."

version="$(git describe --tags --match 'v*')"
version="${version#v}"

projects=()
for p in $(git ls-files '*/composer.json'); do
	projects+=("${p%/*}")
done

err_usage() {
	echo "Usage: $0 { $(printf '%s | ' "${projects[@]}" | sed 's/ | $//') }" >&2
	exit 1
}

in_list() {
	local needle="$1"
	shift
	while [[ $# -gt 0 ]]; do
		if [[ $1 = $needle ]]; then
			return 0
		fi
		shift
	done
	return 1
}

if [[ $# -ne 1 ]]; then
	err_usage
fi

project="$1"
if ! in_list "$project" "${projects[@]}"; then
	err_usage
fi


rm -rf tmp
mkdir tmp
cd "tmp"
mkdir -p "$project/Magento2"
mkdir -p Valued/Magento2
cp -R ../"$project"/ "$project"/Magento2/
cp -R ../common/ Valued/Magento2/

relout="dist/$(echo "$project" | tr '[:upper:]' '[:lower:]')-magento2-"$version".zip"
zip -r -q -X ../"$relout" "$project"/Magento2/ Valued/Magento2/

rm -rf tmp
